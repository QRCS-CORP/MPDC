\doxysection{election.\+h}
\hypertarget{election_8h_source}{}\label{election_8h_source}\index{C:/Users/stepp/Documents/Visual Studio 2022/Projects/C/MPDC/Saved/election.h@{C:/Users/stepp/Documents/Visual Studio 2022/Projects/C/MPDC/Saved/election.h}}
\mbox{\hyperlink{election_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*\ The\ GPL\ version\ 3\ License\ (GPLv3)}}
\DoxyCodeLine{00002\ \textcolor{comment}{*}}
\DoxyCodeLine{00003\ \textcolor{comment}{*\ Copyright\ (c)\ 2022\ Digital\ Freedom\ Defence\ Inc.}}
\DoxyCodeLine{00004\ \textcolor{comment}{*\ This\ file\ is\ part\ of\ the\ QSC\ Cryptographic\ library}}
\DoxyCodeLine{00005\ \textcolor{comment}{*}}
\DoxyCodeLine{00006\ \textcolor{comment}{*\ This\ program\ is\ free\ software\ :\ you\ can\ redistribute\ it\ and\ /\ or\ modify}}
\DoxyCodeLine{00007\ \textcolor{comment}{*\ it\ under\ the\ terms\ of\ the\ GNU\ General\ Public\ License\ as\ published\ by}}
\DoxyCodeLine{00008\ \textcolor{comment}{*\ the\ Free\ Software\ Foundation,\ either\ version\ 3\ of\ the\ License,\ or}}
\DoxyCodeLine{00009\ \textcolor{comment}{*\ (at\ your\ option)\ any\ later\ version.}}
\DoxyCodeLine{00010\ \textcolor{comment}{*}}
\DoxyCodeLine{00011\ \textcolor{comment}{*\ This\ program\ is\ distributed\ in\ the\ hope\ that\ it\ will\ be\ useful,}}
\DoxyCodeLine{00012\ \textcolor{comment}{*\ but\ WITHOUT\ ANY\ WARRANTY;\ without\ even\ the\ implied\ warranty\ of}}
\DoxyCodeLine{00013\ \textcolor{comment}{*\ MERCHANTABILITY\ or\ FITNESS\ FOR\ A\ PARTICULAR\ PURPOSE.See\ the}}
\DoxyCodeLine{00014\ \textcolor{comment}{*\ GNU\ General\ Public\ License\ for\ more\ details.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*}}
\DoxyCodeLine{00016\ \textcolor{comment}{*\ You\ should\ have\ received\ a\ copy\ of\ the\ GNU\ General\ Public\ License}}
\DoxyCodeLine{00017\ \textcolor{comment}{*\ along\ with\ this\ program.\ If\ not,\ see\ <http://www.gnu.org/licenses/>.}}
\DoxyCodeLine{00018\ \textcolor{comment}{*/}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{comment}{/*}}
\DoxyCodeLine{00021\ \textcolor{comment}{Notes:}}
\DoxyCodeLine{00022\ \textcolor{comment}{Should\ control\ messages\ operate\ over\ the\ encryption\ subsystem,\ i.e.\ all\ control\ messages\ }}
\DoxyCodeLine{00023\ \textcolor{comment}{are\ encrypted\ with\ the\ SKDP\ mechanism.\ }}
\DoxyCodeLine{00024\ \textcolor{comment}{This\ normally\ wouldn't\ be\ the\ case,\ it\ is\ computationally\ expensive,\ but\ elections\ are\ periodic,}}
\DoxyCodeLine{00025\ \textcolor{comment}{and\ there\ is\ the\ chance\ that\ an\ election\ could\ be\ manipulated.}}
\DoxyCodeLine{00026\ \textcolor{comment}{Develop\ a\ game\ to\ expose\ attacks\ on\ the\ mechanism,\ and\ define\ which,\ if\ any\ control\ messages\ must\ be\ protected.}}
\DoxyCodeLine{00027\ \textcolor{comment}{*/}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#ifndef\ MPDC\_ELECTION\_H}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#define\ MPDC\_ELECTION\_H}}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#include\ "{}common.h"{}}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mpdc_8h}{mpdc.h}}"{}}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#include\ "{}../QSC/async.h"{}}}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#include\ "{}../QSC/ipinfo.h"{}}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#include\ "{}../QSC/socketclient.h"{}}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#include\ "{}../QSC/memutils.h"{}}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#include\ "{}../QSC/timerex.h"{}}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}}
\DoxyCodeLine{00049\ \{}
\DoxyCodeLine{00050\ \ \ \ \ uint8\_t\ nid[MPDC\_NODEID\_LENGTH];}
\DoxyCodeLine{00051\ \ \ \ \ uint64\_t\ itime;}
\DoxyCodeLine{00052\ \ \ \ \ uint32\_t\ balloc;}
\DoxyCodeLine{00053\ \ \ \ \ uint32\_t\ rtrust;}
\DoxyCodeLine{00054\ \}\ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}};}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00064\ \mbox{\hyperlink{_m_p_d_c_2common_8h_a76d6a26a12f469fcbdc6cabc6027549d}{MPDC\_EXPORT\_API}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{election_8h_a0349d34ad8f01689ee865261555e60e4}{mpdc\_election\_process}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}*\ state,\ \textcolor{keywordtype}{size\_t}\ ecount,\ uint8\_t\ dls[MPDC\_NODEID\_LENGTH],\ uint8\_t\ bls[MPDC\_NODEID\_LENGTH])}
\DoxyCodeLine{00065\ \{}
\DoxyCodeLine{00066\ \ \ \ \ assert(state\ !=\ NULL);}
\DoxyCodeLine{00067\ \ \ \ \ assert(ecount\ !=\ 0);}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}\ tbls\ =\ \{\ 0\ \};}
\DoxyCodeLine{00070\ \ \ \ \ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}\ tdls\ =\ \{\ 0\ \};}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}*\ pes;}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{if}\ (state\ !=\ NULL\ \&\&\ ecount\ >\ 0)}
\DoxyCodeLine{00074\ \ \ \ \ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ find\ the\ highest\ trust\ values\ */}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ ecount;\ ++i)}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ pes\ =\ \&state[i];}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pes-\/>rtrust\ >\ tdls.rtrust)}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(\&tbls,\ \&tdls,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(\&tdls,\ pes,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pes-\/>rtrust\ ==\ tdls.rtrust)}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pes-\/>balloc\ >\ tdls.balloc)}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(\&tbls,\ \&tdls,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(\&tdls,\ pes,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pes-\/>itime\ <\ tdls.itime)}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(\&tbls,\ \&tdls,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(\&tdls,\ pes,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(dls,\ \&tdls,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ qsc\_memutils\_copy(bls,\ \&tbls,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00102\ \ \ \ \ \}}
\DoxyCodeLine{00103\ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \textcolor{comment}{/*\ Note:\ change\ ipinfo\ struct\ with\ one\ containing\ ip\ and\ key\ */}}
\DoxyCodeLine{00106\ \mbox{\hyperlink{_m_p_d_c_2common_8h_a76d6a26a12f469fcbdc6cabc6027549d}{MPDC\_EXPORT\_API}}\ \textcolor{keywordtype}{void}\ mpdc\_election\_call\_ipv4(qsc\_ipinfo\_ipv4\_address*\ local,\ qsc\_ipinfo\_ipv4\_address**\ nodes,\ \textcolor{keywordtype}{size\_t}\ count,\ uint16\_t\ port)}
\DoxyCodeLine{00107\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ count;\ ++i)}
\DoxyCodeLine{00109\ \ \ \ \ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ qsc\_ipinfo\_ipv4\_address*\ pip;}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ pip\ =\ nodes[i];}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (qsc\_ipinfo\_ipv4\_address\_is\_valid(pip))}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_socket\ sock\ =\ \{\ 0\ \};}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ slen;}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_socket\_exceptions\ serr;}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_socket\_client\_initialize(\&sock);}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ serr\ =\ qsc\_socket\_client\_connect\_ipv4(\&sock,\ pip,\ port);}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (serr\ ==\ qsc\_socket\_exception\_success)}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t\ dest[QSC\_IPINFO\_IPV4\_BYTELEN]\ =\ \{\ 0\ \};}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ qsc\_ipinfo\_ipv4\_address\_to\_array(dest,\ pip);}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ TODO:\ define\ and\ serialize\ the\ election\ call\ command\ */}}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Use\ a\ wrapped\ call\ to\ send\ udp\ datagrams,\ that\ is\ encrypted.\ }}
\DoxyCodeLine{00132\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Pass\ a\ state\ that\ includes\ the\ address\ and\ cipher\ state.}}
\DoxyCodeLine{00133\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Then\ call\ into\ the\ encryption\ functions\ locally,\ and\ send\ the\ datagrams\ as\ encrypted\ data.\ */}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//size\_t\ qsc\_socket\_send\_to(const\ qsc\_socket*\ sock,\ const\ char*\ dest,\ size\_t\ sizeof(dest),\ uint16\_t\ port,\ const\ uint8\_t*\ input,\ size\_t\ inlen,\ qsc\_socket\_send\_flags\ flag);}}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ log/action}}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ log/action}}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00145\ \ \ \ \ \}}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \mbox{\hyperlink{_m_p_d_c_2common_8h_a76d6a26a12f469fcbdc6cabc6027549d}{MPDC\_EXPORT\_API}}\ \textcolor{keywordtype}{void}\ mpdc\_election\_broadcast\_ipv4(qsc\_ipinfo\_ipv4\_address**\ nodes,\ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}*\ dls,\ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}*\ bls)}
\DoxyCodeLine{00150\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \textcolor{preprocessor}{\#include\ "{}../QSC/csp.h"{}}}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \textcolor{keywordtype}{void}\ mpdc\_election\_test()}
\DoxyCodeLine{00158\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}\ lpool[10]\ =\ \{\ 0\ \};}
\DoxyCodeLine{00160\ \ \ \ \ uint8\_t\ bls[MPDC\_NODEID\_LENGTH]\ =\ \{\ 0\ \};}
\DoxyCodeLine{00161\ \ \ \ \ uint8\_t\ dls[MPDC\_NODEID\_LENGTH]\ =\ \{\ 0\ \};}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ 10;\ ++i)}
\DoxyCodeLine{00164\ \ \ \ \ \{}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ qsc\_csp\_generate((uint8\_t*)\&lpool[i],\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmpdc__election__state}{mpdc\_election\_state}}));}
\DoxyCodeLine{00166\ \ \ \ \ \}}
\DoxyCodeLine{00167\ \ \ \ \ }
\DoxyCodeLine{00168\ \ \ \ \ \mbox{\hyperlink{election_8h_a0349d34ad8f01689ee865261555e60e4}{mpdc\_election\_process}}(lpool,\ 10,\ dls,\ bls);}
\DoxyCodeLine{00169\ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
